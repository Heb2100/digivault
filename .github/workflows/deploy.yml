name: CI/CD to GKE (using Artifact Registry)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Set up GCP auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY }}

      - name: Configure Docker to use gcloud as a credential helper
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev

      - name: Build and Push Docker image to Artifact Registry
        run: |
          IMAGE_REPO="asia-northeast3-docker.pkg.dev/aesthetic-fiber-462503-t5/digivault"
          IMAGE_NAME="digivault-app"
          IMAGE_TAG="2506102148"

          docker build -t $IMAGE_REPO/$IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_REPO/$IMAGE_NAME:$IMAGE_TAG

      - name: Set up kubectl
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: aesthetic-fiber-462503-t5
          install_components: kubectl

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials digivault-cluster --region asia-northeast3
        
        ?, ????. Helm? ?????? ????, ???? Helm Chart? ???? deployment.yaml ??? ???? ???? ???? ??? ??????.

1. Helm ???
Helm? Kubernetes? ?? ??? ???(Package Manager) ???. ????? ??? ???(?: Ubuntu? apt, macOS? brew, CentOS? yum ?)? ??? ??? Kubernetes ????? ?????.

Helm? ?? ?:

?????? ?? ? ?? ???: ??? Kubernetes YAML ??(Deployment, Service, ConfigMap, Ingress ?)?? ??? ?? "??(Chart)"?? ???? ???, ?? ?? ??????? ?? ???? ??? ? ??? ?????.
???? ? ????: ?? ???? Kubernetes ??? ??? ????? ?????, ??? ??? ??? ?(?: ??? ??, ??, replicas ?)? ???? ???? ? ????.
?? ?? ? ??: ??? ??????? ??? ????, ??? ???? ? ?? ???? ?? ??? ? ?? ??? ?????.
??? ??: ?? ?? ???????? ??? ??? ??????? ??, ? ??? ?? ???? Helm Chart ??? ???? ?? ??? ? ????.
?????, Helm? Kubernetes? ??????? ???? ???? ??? ?? ? ?? ????? ????? ?????.

2. Helm Chart ?? ?? ???
?? ?? ? ?? Helm Chart? ?? ???? ??? ???? ????. ??????? helm upgrade --install digivault ./helm ?? ?? ???, ./helm ????? ??? ??? ???.

???? ?? ????(GitHub Actions ????? ??? ?? ?)?? ?? ???? ???? helm ???? ?? digivault?? ??? ? ??? ?????.

Bash

cd ~/digivault_project/digivault # ? ????? ?? ?? ?????? ??
helm create helm/digivault
? ???? ???? helm/digivault ???? ??? ??? ?? ?? ??? ?????:

helm/
+-- digivault/
    +-- Chart.yaml             # ??? ????? (??, ??, ?? ?)
    +-- values.yaml            # ??? ?? ??? (???? ??? ???)
    +-- templates/             # Kubernetes ??? ?? ??? ???? ???? ????
    |   +-- deployment.yaml    # ??????? ?? (Pod ??) ??
    |   +-- service.yaml       # ??????? ??? (???? ??) ??
    |   +-- ingress.yaml       # (?? ??) ?? ??? ?? Ingress ??
    |   +-- _helpers.tpl       # (?? ??) ????? ???? ?? ?? ??
    |   +-- NOTES.txt          # ?? ?? ? ????? ??? ???
    +-- .helmignore            # Helm? ???? ? ??? ??/???? ??
??? ?? ??? ???? Chart.yaml, values.yaml, ??? templates/ ???? ?? ??????.

3. Chart.yaml ?? (?????)
helm/digivault/Chart.yaml ??? ???. ? ??? ??? ?? ??? ?? ????.

YAML

# helm/digivault/Chart.yaml
apiVersion: v2
name: digivault          # ?? ?? (??? ??? ? ??? ??)
description: A Helm chart for Digivault application # ??? ?? ??

# A chart can be either an application chart or a library chart.
#
# Application charts are a collection of templates that can be packaged into a helm chart.
# Library charts provide useful utilities or functions for the chart developer.
type: application

# This is the chart version. This version number should be incremented each time you make changes
# to the chart and want to release a new version.
version: 0.1.0 # ?? ?? (??? ???? ? ??)

# This is the version number of the application being deployed. This is not DRAFT.
# This value is not incremented each time you make a change to the chart.
# If you want to associate the application version with a chart pass it as a parameter.
appVersion: "1.16.0" # ??? ??????? ?? (??? ??? ?? ? ??)
???? ????? ??? ?????.

4. values.yaml ?? (??? ??)
helm/digivault/values.yaml ??? ???? ??? ????? ?????. GitHub Actions ??????? --set?? ?? ???? ? values.yaml? ???? ??????? ???.

?? ??????? --set image.repository? --set image.tag? ???? ????, values.yaml?? ?? ??? ??? ??? ???.

YAML

# helm/digivault/values.yaml

replicaCount: 1 # ??? Pod? ?? ??

image:
  repository: asia-northeast3-docker.pkg.dev/aesthetic-fiber-462503-t5/digivault/digivault-app # Artifact Registry? ?? ??? ??
  tag: "latest" # ???? ?? ??
  pullPolicy: IfNotPresent # ??? ???? ?? (Always? ?? ??)

service:
  type: LoadBalancer # ??? ?? (ClusterIP, NodePort, LoadBalancer)
  port: 80 # ???? ??? ??
  targetPort: 8080 # ????? ????? ?? (digivault ?? ?? ??)

# ingress:
#   enabled: false
#   className: ""
#   annotations: {}
#     # kubernetes.io/ingress.class: nginx
#     # kubernetes.io/tls-acme: "true"
#   hosts:
#     - host: chart-example.local
#       paths:
#         - path: /
#           pathType: ImplementationSpecific
#   tls: []
#   #  - secretName: chart-example-tls
#   #    hosts:
#   #      - chart-example.local

resources: {}
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts will run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

nodeSelector: {}

tolerations: []

affinity: {}
????:

image.repository? image.tag? GitHub Actions ??????? --set?? ?????? ????.
service.targetPort? digivault ??????? ?? ???? ???? ????? ?? ???? ???. (????? ? ??? 8080 ?? 80)
5. templates/deployment.yaml ??
helm/digivault/templates/deployment.yaml ??? ?????? Pod? ???? Kubernetes Deployment ???? ?????. values.yaml? ??? ?? ??? ???? ??? ?????.

??? helm create ???? ??? ???? ??? ??? ?????, ?? ???? ?????.

YAML

# helm/digivault/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "digivault.fullname" . }} # Helm ??? ?? ??? ???? Deployment? ?? ??
  labels:
    {{- include "digivault.labels" . | nindent 4 }} # Helm ??? ?? ??? ???? ?? ??
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }} # values.yaml? replicaCount ?? ??
  {{- end }}
  selector:
    matchLabels:
      {{- include "digivault.selectorLabels" . | nindent 6 }} # ??? ??
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "digivault.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "digivault.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: {{ .Chart.Name }} # ???? ?? (?? ??? ????)
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}" # Artifact Registry ??? ??? ??
          imagePullPolicy: {{ .Values.image.pullPolicy }} # values.yaml? image.pullPolicy ?? (Always ??)
          ports:
            - name: http
              containerPort: {{ .Values.service.targetPort }} # values.yaml? service.targetPort ??
              protocol: TCP
          livenessProbe:
            httpGet:
              path: / # ??????? ?? ?? ?? (??? ??)
              port: http
          readinessProbe:
            httpGet:
              path: / # ??????? ?? ?? ?? (??? ??)
              port: http
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
???? ?? ? ??:

name: {{ include "digivault.fullname" . }}: Deployment? ??? ???? ??. _helpers.tpl ??? ??? fullname ?? ??? ?????.
replicas: {{ .Values.replicaCount }}: values.yaml? ??? replicaCount ?? ??? ?????.
image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}": ? ??? ?? ?????. values.yaml?? ??? image.repository? image.tag ?? ???? Docker ??? ??? ?????. ?????? --set?? ? ?? ?????? ????.
imagePullPolicy: {{ .Values.image.pullPolicy }}: values.yaml? ??? imagePullPolicy? ?????. ? ?? Always? ???? ?? ????.
containerPort: {{ .Values.service.targetPort }}: values.yaml? ??? service.targetPort ?? ?????. ?? ???? ???? ??????? ????? ?????.
6. templates/service.yaml ??
helm/digivault/templates/service.yaml ??? ???? ?????? Pod? ??? ? ??? Kubernetes Service ???? ?????.

??? helm create ???? ??? ???? ??? ??? ?????, ?? ???? ?????.

YAML

# helm/digivault/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ include "digivault.fullname" . }}-service # ??? ??? fullname ?? ?? ??
  labels:
    {{- include "digivault.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }} # values.yaml? service.type ?? (LoadBalancer)
  ports:
    - port: {{ .Values.service.port }} # ???? ??? ?? ??
      targetPort: http # ????? ?? ?? (deployment.yaml? name: http? ??)
      protocol: TCP
      name: http
  selector:
    {{- include "digivault.selectorLabels" . | nindent 4 }} # Deployment? Pod? ??? ??
???? ?? ? ??:

type: {{ .Values.service.type }}: values.yaml? service.type? ??? ?????. LoadBalancer? ???? ???? ???? ?? IP? ?????.
port: {{ .Values.service.port }}: ???? ??? ??? ????? (?: 80).
targetPort: http: Deployment?? ???? ??? name: http? ??????, ???? ? ??? ?????. ??? ?? ?? ??? ????? ??? ??? ??? ??? ?? ?????.
selector: ...: ? ???? ???? ??? Pod?? ???? ?????. Deployment? Pod ??? ???? ???.
7. templates/_helpers.tpl (?? ????? ???)
helm create ???? ??? _helpers.tpl ??? Helm ?? ??? ??? ??? ?? ???? ?????. fullname?? labels ?? ???? ? ??? ???? ????. ????? ? ??? ??? ??? ???.

?? ????? (.github/workflows/ci-cd-gke.yml) (?? ??)
?? Helm Chart? ??????, ?? GitHub Actions ?????? Helm Chart? ???? ? ??? ??? ? ????? ???.

YAML

# .github/workflows/ci-cd-gke.yml
name: CI/CD to GKE (using Artifact Registry)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Set up GCP auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY }}

      - name: Configure Docker to use gcloud as a credential helper
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev

      - name: Build and Push Docker image to Artifact Registry
        run: |
          # Git ?? ??? ??? ??? ?? (??)
          IMAGE_TAG=$(git rev-parse --short HEAD) 
          # ?? ?????: IMAGE_TAG=$(date +%Y%m%d%H%M%S) 

          IMAGE_REPO="asia-northeast3-docker.pkg.dev/aesthetic-fiber-462503-t5/digivault"
          IMAGE_NAME="digivault-app" # values.yaml? image.name? ??
          
          docker build -t $IMAGE_REPO/$IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_REPO/$IMAGE_NAME:$IMAGE_TAG
          
          echo "NEW_IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV # ?? ???? ??? ?? ?? ??

      - name: Set up kubectl
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: aesthetic-fiber-462503-t5
          install_components: kubectl

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials digivault-cluster --region asia-northeast3

      - name: Deploy via Helm
        run: |
          IMAGE_REPO="asia-northeast3-docker.pkg.dev/aesthetic-fiber-462503-t5/digivault"
          IMAGE_NAME="digivault-app"

          helm upgrade --install digivault ./helm/digivault \
            --set image.repository=$IMAGE_REPO \
            --set image.name=$IMAGE_NAME \ # image.name ??
            --set image.tag=${{ env.NEW_IMAGE_TAG }} \ # ?? ?? ??
            --set image.pullPolicy=Always # ?? ?? ??? ????? ??