name: CI/CD to GKE (using Artifact Registry)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Set up GCP auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY }}

      - name: Configure Docker to use gcloud as a credential helper
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev

      - name: Build and Push Docker image to Artifact Registry
        run: |
          IMAGE_REPO="asia-northeast3-docker.pkg.dev/aesthetic-fiber-462503-t5/digivault"
          IMAGE_NAME="digivault-app"
          IMAGE_TAG="2506102148"

          docker build -t $IMAGE_REPO/$IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_REPO/$IMAGE_NAME:$IMAGE_TAG

          echo "NEW_IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV 

      - name: Set up kubectl
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: aesthetic-fiber-462503-t5
          install_components: kubectl

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials digivault-cluster --region asia-northeast3

      - name: Deploy via Helm
        run: |
          IMAGE_REPO="asia-northeast3-docker.pkg.dev/aesthetic-fiber-462503-t5/digivault"
          IMAGE_NAME="digivault-app"

          helm upgrade --install digivault ./helm/digivault --set image.repository=$IMAGE_REPO --set image.name=$IMAGE_NAME --set image.tag=${{ env.NEW_IMAGE_TAG }} --set image.tag=${{ env.NEW_IMAGE_TAG }} --set image.pullPolicy=Always